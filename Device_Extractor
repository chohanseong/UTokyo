import pandas as pd
import numpy as np
import os
import matplotlib.pyplot as plt
from scipy.stats import linregress

# --- ì†Œìˆ˜ì  3ìë¦¬ê¹Œì§€ ---
pd.set_option('display.float_format', lambda x: f"{x:.4f}")

# --- íŒŒì¼ ê²½ë¡œ ì„¤ì • ---
file_path = "nMOS.xlsx"  # ì—‘ì…€ íŒŒì¼ (A,Bì—´: Vd=0.05V, C,Dì—´: Vd=1.12V)

# --- íŒŒì¼ ì¡´ì¬ í™•ì¸ ---
if not os.path.exists(file_path):
    print(f"âš ï¸ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: {file_path}")
    print(f"í˜„ì¬ ì‘ì—… í´ë”: {os.getcwd()}")
    exit()

# --- íŒŒì¼ ë¡œë“œ ---
df = pd.read_excel(file_path, engine="openpyxl")
print("âœ… íŒŒì¼ì´ ì •ìƒì ìœ¼ë¡œ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.")
print(df.head())

# --- ë°ì´í„° ë¼ë²¨ë§ ---
# Vd = 0.05 V ë°ì´í„°: Aì—´ (Vg), Bì—´ (Id)
Vg_05 = df.iloc[:, 0].values.astype(float)
Id_05 = np.abs(df.iloc[:, 1].values.astype(float))  # ìŒìˆ˜ë¥¼ ì ˆëŒ“ê°’ ì²˜ë¦¬

# Vd = 1.12 V ë°ì´í„°: Cì—´ (Vg), Dì—´ (Id)
Vg_112 = df.iloc[:, 2].values.astype(float)
Id_112 = np.abs(df.iloc[:, 3].values.astype(float))  # ìŒìˆ˜ë¥¼ ì ˆëŒ“ê°’ ì²˜ë¦¬

# --- ë¡œê·¸ ë³€í™˜ (Id > 0 ì¸ ë°ì´í„°ë§Œ ì‚¬ìš©) ---
valid_idx_05 = Id_05 > 0
Vg_05_valid = Vg_05[valid_idx_05]
logId_05 = np.log10(Id_05[valid_idx_05])

valid_idx_112 = Id_112 > 0
Vg_112_valid = Vg_112[valid_idx_112]
logId_112 = np.log10(Id_112[valid_idx_112])

# --- í•¨ìˆ˜ ì •ì˜: ë¡œê·¸ ìŠ¤ì¼€ì¼ ë‚´ë¶„ë²•ìœ¼ë¡œ Vth ì¶”ì¶œ ---
def extract_Vth(Vg, logId, target=-7):
    """
    Vgì™€ log10(Id) ë°ì´í„°ë¥¼ ì´ìš©í•˜ì—¬, target (ì˜ˆ: -7)ì— ëŒ€í•´
    ì¸ì ‘í•œ ë‘ ì  ì‚¬ì´ì˜ linear interpolationìœ¼ë¡œ Vthë¥¼ ê³„ì‚°.
    """
    for i in range(len(logId) - 1):
        if (logId[i] - target) * (logId[i+1] - target) <= 0:
            Vg_low = Vg[i]
            Vg_high = Vg[i+1]
            logId_low = logId[i]
            logId_high = logId[i+1]
            if logId_high == logId_low:
                return Vg[i]
            Vth = Vg_low + (Vg_high - Vg_low) * (target - logId_low) / (logId_high - logId_low)
            return Vth
    return None

# --- Vth ì¶”ì¶œ ---
target_log = -7
Vth_05 = extract_Vth(Vg_05_valid, logId_05, target=target_log)
Vth_112 = extract_Vth(Vg_112_valid, logId_112, target=target_log)

# --- DIBL ê³„ì‚° ---
# DIBL = (Vth@0.05V - Vth@1.12V) / 1.15 * 1000 [mV/V]
if Vth_05 is not None and Vth_112 is not None:
    DIBL = abs((Vth_05 - Vth_112) / 1.15 * 1000)
else:
    DIBL = None

# --- gm ê³„ì‚° (Vd = 0.05 V ë°ì´í„°, raw Id ë¯¸ë¶„) ---
gm_values = np.gradient(Id_05, Vg_05)
max_gm = np.max(np.abs(gm_values))*1e6

# --- í•¨ìˆ˜ ì •ì˜: ì£¼ì–´ì§„ target ê¸°ì¤€ SS ê³„ì‚° ---
def compute_SS(Vg_valid, logId, target):
    """
    ì£¼ì–´ì§„ Vg_valid, log10(Id) ë°ì´í„°ì—ì„œ target ê°’(ì˜ˆ: -7 ë˜ëŠ” -8)ì— ëŒ€í•´,
    ì•„ë˜ìª½(â‰¤ target)ì—ì„œ ê°€ì¥ ê°€ê¹Œìš´ 2ê°œì™€ ìœ„ìª½(> target)ì—ì„œ ê°€ì¥ ê°€ê¹Œìš´ 3ê°œ ë°ì´í„°ë¥¼ ì„ íƒí•œ í›„
    ì„ í˜• íšŒê·€ë¥¼ ìˆ˜í–‰í•˜ì—¬ SS (mV/dec)ë¥¼ ê³„ì‚°.
    """
    below_indices = np.where(logId <= target)[0]
    above_indices = np.where(logId > target)[0]
    
    if len(below_indices) >= 2:
        diff_below = np.abs(logId[below_indices] - target)
        sorted_below = below_indices[np.argsort(diff_below)]
        selected_below = sorted_below[:2]
    else:
        selected_below = below_indices

    if len(above_indices) >= 3:
        diff_above = np.abs(logId[above_indices] - target)
        sorted_above = above_indices[np.argsort(diff_above)]
        selected_above = sorted_above[:3]
    else:
        selected_above = above_indices

    indices = np.concatenate((selected_below, selected_above))
    
    if len(indices) >= 2:
        slope, _, _, _, _ = linregress(Vg_valid[indices], logId[indices])
        return (1 / slope) * 1000  # mV/dec ë‹¨ìœ„
    else:
        return None

# --- SS ê³„ì‚° ---  
SS_1E7 = abs(compute_SS(Vg_05_valid, logId_05, target=-7))  # 1E-7 ê¸°ì¤€
SS_1E8 = abs(compute_SS(Vg_05_valid, logId_05, target=-8))  # 1E-8 ê¸°ì¤€

# --- ê²°ê³¼ ì¶œë ¥ ---
results = pd.DataFrame({
    "Parameter": ["(Vd=0.05V) Vth (V)", "(Vd=1.12V) Vth (V)", "DIBL (mV/V)", "gm max (Î¼S)", "SS 1E-7 (mV/dec)", "SS 1E-8 (mV/dec)"],
    "Value": [Vth_05, Vth_112, DIBL, max_gm, SS_1E7, SS_1E8]
})
print("\nğŸ”¹ Extracted Device Parameters (log scale ê¸°ì¤€) ğŸ”¹")
print(results.to_string(index=False))

# --- ê·¸ë˜í”„ ì‹œê°í™”  ---
plt.figure(figsize=(8, 6))

# Vd = 0.05 V ë°ì´í„° (íŒŒë€ìƒ‰)
plt.plot(Vg_05_valid, logId_05, 'o-', color='blue', label='Vd = 0.05V')
# target ê¸°ì¤€ ë³´ì¡°ì„ ë“¤
plt.axhline(y=-7, color='r', linestyle='--', label='Target log(Id)=-7')
if Vth_05 is not None:
    plt.axvline(x=Vth_05, color='g', linestyle='--', label=f'Vth (0.05V, target=-7)={Vth_05:.3f} V')

# Vd = 1.2 V ë°ì´í„° (ë¹¨ê°„ìƒ‰)
plt.plot(Vg_112_valid, logId_112, 'o-', color='red', label='Vd = 1.2V')
if Vth_112 is not None:
    plt.axvline(x=Vth_112, color='g', linestyle='--', label=f'Vth (1.2V, target=-7)={Vth_112:.3f} V')

plt.xlabel("Gate Voltage (V)")
plt.ylabel("Drain Current*(L/W) (A)")
plt.title("Vg-Id (Vd = 0.05V and Vd = 1.2V)")
plt.legend()
plt.grid(True)
plt.show()
